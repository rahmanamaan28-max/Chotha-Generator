<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chotha Maker - AI Study Notes Generator</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 1.5rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        h1 {
            text-align: center;
            color: #4a5568;
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .subtitle {
            text-align: center;
            color: #718096;
            font-size: 1.2rem;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .specs {
            text-align: center;
            color: #4a5568;
            font-size: 0.9rem;
            background: rgba(255,255,255,0.8);
            padding: 0.5rem;
            border-radius: 10px;
            margin: 1rem auto;
            max-width: 600px;
        }

        .upload-section {
            background: white;
            border-radius: 25px;
            padding: 3rem;
            margin: 2rem auto;
            box-shadow: 0 15px 50px rgba(0,0,0,0.1);
            max-width: 900px;
            border: 3px solid transparent;
            background-clip: padding-box;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 20px;
            padding: 4rem 2rem;
            text-align: center;
            background: linear-gradient(135deg, #f8faff 0%, #e6f3ff 100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .upload-area::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: transform 0.6s ease;
            transform: translateX(-100%) translateY(-100%) rotate(45deg);
        }

        .upload-area:hover::before {
            transform: translateX(100%) translateY(100%) rotate(45deg);
        }

        .upload-area:hover {
            background: linear-gradient(135deg, #e6f3ff 0%, #d1e7ff 100%);
            border-color: #4c63d2;
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }

        .upload-area.dragover {
            background: linear-gradient(135deg, #d1e7ff 0%, #b8d8ff 100%);
            border-color: #4c63d2;
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.3);
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            color: #667eea;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .upload-text {
            font-size: 1.4rem;
            color: #4a5568;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .file-types {
            color: #718096;
            font-size: 1rem;
            margin: 1.5rem 0;
            line-height: 1.6;
        }

        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1.2rem 2.5rem;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 0.5rem;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background: #a0aec0;
            box-shadow: none;
        }

        .progress-container {
            margin: 2rem 0;
            display: none;
            background: #f7fafc;
            padding: 1.5rem;
            border-radius: 15px;
            border: 1px solid #e2e8f0;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 6px;
        }

        .progress-text {
            text-align: center;
            margin-top: 1rem;
            color: #4a5568;
            font-weight: 600;
        }

        .status {
            margin-top: 1rem;
            padding: 1.2rem;
            border-radius: 12px;
            display: none;
            font-weight: 600;
            font-size: 1rem;
        }

        .status.success {
            background: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%);
            color: #38a169;
            border: 2px solid #9ae6b4;
        }

        .status.error {
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
            color: #e53e3e;
            border: 2px solid #feb2b2;
        }

        .chotha-container {
            display: none;
            margin: 3rem auto;
            max-width: 1200px;
            background: rgba(255,255,255,0.95);
            border-radius: 25px;
            padding: 3rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
        }

        .chotha-title {
            text-align: center;
            color: #4a5568;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .chotha-boxes {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }

        .chotha-box {
            background: white;
            border: 2px solid #2d3748;
            width: 288px;
            height: 288px;
            padding: 12px;
            font-family: 'Arial MT', Arial, sans-serif;
            font-size: 8px;
            line-height: 1.1;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 0;
            display: flex;
            flex-direction: column;
        }

        .chotha-box h3 {
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 8px;
            font-size: 9px;
            color: #2d3748;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 4px;
            flex-shrink: 0;
        }

        .chotha-box .content {
            flex: 1;
            overflow-y: auto;
        }

        .chotha-box ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .chotha-box li {
            margin: 1px 0;
            font-size: 7px;
            color: #2d3748;
            line-height: 1.2;
        }

        .export-section {
            display: none;
            text-align: center;
            margin: 3rem 0;
            padding: 3rem;
            background: rgba(255,255,255,0.95);
            border-radius: 25px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
        }

        .export-title {
            font-size: 2rem;
            color: #4a5568;
            margin-bottom: 2rem;
            font-weight: 700;
        }

        .file-info {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            display: none;
            border: 2px solid #e2e8f0;
        }

        .file-info h4 {
            color: #4a5568;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .file-info ul {
            list-style: none;
            padding: 0;
        }

        .file-info li {
            padding: 0.5rem 0;
            color: #718096;
            border-bottom: 1px solid #e2e8f0;
        }

        .file-info li:last-child {
            border-bottom: none;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 3rem 0;
            padding: 3rem;
            background: rgba(255,255,255,0.95);
            border-radius: 25px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
        }

        .spinner {
            border: 5px solid #e2e8f0;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.3rem;
            color: #4a5568;
            font-weight: 600;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin: 4rem 0;
        }

        .feature {
            background: rgba(255,255,255,0.9);
            padding: 2.5rem;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .feature:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .feature-icon {
            font-size: 3rem;
            margin-bottom: 1.5rem;
            display: block;
        }

        .feature h3 {
            color: #4a5568;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .feature p {
            color: #718096;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .upload-section, .chotha-container, .export-section, .loading {
                margin: 1rem;
                padding: 2rem;
            }
            
            .chotha-box {
                width: 100%;
                max-width: 288px;
            }
        }

        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .chotha-container, .chotha-container * {
                visibility: visible;
            }
            
            .chotha-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white !important;
                box-shadow: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            
            .chotha-title {
                color: black !important;
                text-shadow: none !important;
            }
            
            .chotha-box {
                break-inside: avoid;
                margin: 5mm;
                box-shadow: none !important;
                border: 2px solid black !important;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>🎯 Chotha Maker</h1>
            <p class="subtitle">AI-Powered Study Notes Generator with Advanced Document Processing</p>
            <div class="specs">
                3×3 inch boxes | Arial MT | Font size 3 | Ultra-compact | Exam-ready format
            </div>
        </div>
    </div>

    <div class="container">
        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">📚</div>
                <div class="upload-text">Drop your study materials here</div>
                <div class="file-types">
                    <strong>Supported formats:</strong><br>
                    📄 PDF documents | 📝 Word files (DOCX) | 🖼️ Images with OCR<br>
                    📊 PowerPoint slides | 📋 Text files
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".pdf,.docx,.doc,.ppt,.pptx,.txt,.jpg,.jpeg,.png" multiple>
                <button class="btn" onclick="document.getElementById('fileInput').click()">
                    Browse Files
                </button>
            </div>

            <div class="file-info" id="fileInfo"></div>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Processing files...</div>
            </div>

            <div class="status" id="status"></div>

            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn" id="generateBtn" onclick="generateChotha()" disabled>
                    🚀 Generate Chotha Notes
                </button>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div class="loading-text">AI is creating your Chotha notes...</div>
            <div style="margin-top: 1rem; color: #718096;">
                Processing content • Formatting boxes • Applying Chotha rules
            </div>
        </div>

        <div class="chotha-container" id="chothaContainer">
            <div class="chotha-title">📝 Your Exam-Ready Chotha Notes</div>
            <div class="chotha-boxes" id="chothaBoxes"></div>
        </div>

        <div class="export-section" id="exportSection">
            <div class="export-title">Export Your Chotha Notes</div>
            <button class="btn" onclick="exportToPDF()">📄 Download PDF</button>
            <button class="btn" onclick="exportToWord()">📝 Download DOCX</button>
            <button class="btn" onclick="printNotes()">🖨️ Print Notes</button>
        </div>

        <div class="features">
            <div class="feature">
                <div class="feature-icon">🔍</div>
                <h3>Advanced OCR</h3>
                <p>Extract text from images and scanned documents using Tesseract.js OCR technology</p>
            </div>
            <div class="feature">
                <div class="feature-icon">📄</div>
                <h3>PDF Processing</h3>
                <p>Full PDF text extraction using PDF.js library with page-by-page processing</p>
            </div>
            <div class="feature">
                <div class="feature-icon">📝</div>
                <h3>Word Documents</h3>
                <p>Complete DOCX processing using Mammoth.js for perfect text extraction</p>
            </div>
            <div class="feature">
                <div class="feature-icon">🎯</div>
                <h3>Perfect Chotha Format</h3>
                <p>Exact 3×3 inch boxes, Arial MT font, ultra-compact micro-bullets format</p>
            </div>
        </div>
    </div>

    <script>
        // Set PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let extractedText = '';
        let processedFiles = [];

        // DOM elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const status = document.getElementById('status');
        const generateBtn = document.getElementById('generateBtn');
        const loading = document.getElementById('loading');
        const chothaContainer = document.getElementById('chothaContainer');
        const exportSection = document.getElementById('exportSection');

        // Event listeners
        uploadArea.addEventListener('click', (e) => {
            if (e.target !== fileInput) {
                fileInput.click();
            }
        });

        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        uploadArea.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            processFiles(files);
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            processFiles(files);
        }

        async function processFiles(files) {
            if (files.length === 0) return;

            processedFiles = files;
            showProgress();
            
            let allText = '';
            let fileInfoHTML = '<h4>📁 Processing Files:</h4><ul>';
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
                fileInfoHTML += `<li><strong>${file.name}</strong> (${fileSizeMB} MB) - Processing...</li>`;
                
                updateProgress((i / files.length) * 90, `Processing ${file.name}...`);
                
                try {
                    let text = '';
                    const fileName = file.name.toLowerCase();
                    
                    if (file.type === 'application/pdf' || fileName.endsWith('.pdf')) {
                        text = await extractTextFromPDF(file);
                    } else if (file.type.includes('wordprocessingml') || fileName.endsWith('.docx') || fileName.endsWith('.doc')) {
                        text = await extractTextFromWord(file);
                    } else if (file.type.includes('presentationml') || fileName.endsWith('.ppt') || fileName.endsWith('.pptx')) {
                        text = await extractTextFromPowerPoint(file);
                    } else if (file.type.startsWith('image/')) {
                        text = await extractTextFromImage(file);
                    } else if (file.type === 'text/plain' || fileName.endsWith('.txt')) {
                        text = await extractTextFromTxt(file);
                    } else {
                        text = `[Unsupported file type: ${file.name}]`;
                    }
                    
                    allText += `\n\n=== ${file.name.toUpperCase()} ===\n${text}`;
                    
                } catch (error) {
                    console.error(`Error processing ${file.name}:`, error);
                    showStatus(`❌ Error processing ${file.name}: ${error.message}`, 'error');
                    allText += `\n\n=== ${file.name.toUpperCase()} ===\n[Error: ${error.message}]`;
                }
            }
            
            fileInfoHTML += '</ul>';
            fileInfo.innerHTML = fileInfoHTML;
            fileInfo.style.display = 'block';
            
            extractedText = allText.trim();
            updateProgress(100, 'Processing complete!');
            
            setTimeout(() => {
                hideProgress();
                
                if (extractedText && extractedText.length > 50) {
                    generateBtn.disabled = false;
                    showStatus('✅ Files processed successfully! Ready to generate Chotha notes.', 'success');
                } else {
                    showStatus('⚠️ No readable text found in uploaded files. Please try different files.', 'error');
                }
            }, 500);
        }

        // PDF text extraction
        async function extractTextFromPDF(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const pdf = await pdfjsLib.getDocument({data: e.target.result}).promise;
                        let fullText = '';
                        
                        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                            updateProgress(50 + (pageNum / pdf.numPages) * 30, `Reading PDF page ${pageNum}/${pdf.numPages}...`);
                            
                            const page = await pdf.getPage(pageNum);
                            const textContent = await page.getTextContent();
                            const pageText = textContent.items.map(item => item.str).join(' ');
                            fullText += `\nPAGE ${pageNum}:\n${pageText}\n`;
                        }
                        
                        resolve(fullText);
                    } catch (error) {
                        reject(new Error(`PDF processing failed: ${error.message}`));
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read PDF file'));
                reader.readAsArrayBuffer(file);
            });
        }

        // Word document text extraction
        async function extractTextFromWord(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    mammoth.extractRawText({arrayBuffer: e.target.result})
                        .then(result => {
                            if (result.value && result.value.trim()) {
                                resolve(result.value);
                            } else {
                                reject(new Error('No text content found in Word document'));
                            }
                        })
                        .catch(error => reject(new Error(`Word processing failed: ${error.message}`)));
                };
                reader.onerror = () => reject(new Error('Failed to read Word file'));
                reader.readAsArrayBuffer(file);
            });
        }

        // PowerPoint text extraction (basic)
        async function extractTextFromPowerPoint(file) {
            return new Promise((resolve) => {
                resolve(`[PowerPoint: ${file.name}]\nPowerPoint processing requires specialized libraries. Please export your slides as PDF or copy-paste the content.`);
            });
        }

        // OCR text extraction from images
        async function extractTextFromImage(file) {
            return new Promise((resolve, reject) => {
                updateProgress(20, 'Initializing OCR...');
                
                Tesseract.recognize(file, 'eng', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            updateProgress(20 + (m.progress * 60), `OCR Processing: ${Math.round(m.progress * 100)}%`);
                        }
                    }
                }).then(({ data: { text } }) => {
                    if (text && text.trim()) {
                        resolve(text);
                    } else {
                        reject(new Error('No text detected in image'));
                    }
                }).catch(error => reject(new Error(`OCR failed: ${error.message}`)));
            });
        }

        // Text file extraction
        async function extractTextFromTxt(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = () => reject(new Error('Failed to read text file'));
                reader.readAsText(file);
            });
        }

        function showProgress() {
            progressContainer.style.display = 'block';
        }

        function hideProgress() {
            progressContainer.style.display = 'none';
        }

        function updateProgress(percent, text) {
            progressFill.style.width = Math.min(percent, 100) + '%';
            progressText.textContent = text;
        }

        function showStatus(message, type) {
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }

        function hideStatus() {
            status.style.display = 'none';
        }

        async function generateChotha() {
            if (!extractedText.trim()) {
                showStatus('❌ No content available. Please upload and process files first.', 'error');
                return;
            }

            loading.style.display = 'block';
            hideStatus();
            
            try {
                // Simulate AI processing
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const chothaBoxes = createChothaBoxes(extractedText);
                displayChothaBoxes(chothaBoxes);
                
                loading.style.display = 'none';
                chothaContainer.style.display = 'block';
                exportSection.style.display = 'block';
                
                chothaContainer.scrollIntoView({ behavior: 'smooth' });
                showStatus('🎉 Chotha notes generated successfully!', 'success');
                
            } catch (error) {
                loading.style.display = 'none';
                showStatus('❌ Error generating Chotha notes. Please try again.', 'error');
                console.error('Generation error:', error);
            }
        }

        function createChothaBoxes(text) {
            // Advanced text processing for Chotha format
            const sections = identifySections(text);
            const chothaBoxes = [];
            
            sections.forEach((section, index) => {
                if (!section.content.trim()) return;
                
                const title = section.title || `TOPIC ${index + 1}`;
                const processedContent = processContentForChotha(section.content);
                
                if (processedContent.length > 0) {
                    chothaBoxes.push({
                        title: title.toUpperCase(),
                        content: processedContent
                    });
                }
            });
            
            return chothaBoxes;
        }

        function identifySections(text) {
            const sections = [];
            
            // Split by file markers first
            const fileBlocks = text.split(/=== .+ ===/);
            
            fileBlocks.forEach(block => {
                if (!block.trim()) return;
                
                // Look for natural section breaks
                const paragraphs = block.split(/\n\s*\n+/).filter(p => p.trim());
                
                paragraphs.forEach((paragraph, index) => {
                    const lines = paragraph.trim().split('\n');
                    if (lines.length === 0) return;
                    
                    // Try to extract title from first line
                    let title = extractSectionTitle(lines[0]);
                    let content = lines.slice(title ? 1 : 0).join('\n');
                    
                    // If no clear title, create one from content
                    if (!title) {
                        title = generateTitleFromContent(lines[0]);
                    }
                    
                    sections.push({
                        title: title,
                        content: content
                    });
                });
            });
            
            return sections;
        }

        function extractSectionTitle(line) {
            const cleanLine = line.trim();
            
            // Check for common title patterns
            const titlePatterns = [
                /^(chapter|section|unit|lesson|topic)\s+\d+[\.\:\-\s]*(.*)/i,
                /^[A-Z\s]{3,}$/,
                /^[IVX]+[\.\)\s]+(.*)/i,
                /^\d+[\.\)\s]+(.*)/,
                /^[A-Za-z\s]{5,40}$/
            ];
            
            for (const pattern of titlePatterns) {
                const match = cleanLine.match(pattern);
                if (match) {
                    return match[1] || cleanLine;
                }
            }
            
            // Check if line is likely a title (short, no punctuation at end)
            if (cleanLine.length < 60 && !cleanLine.match(/[.!?]$/)) {
                return cleanLine;
            }
            
            return null;
        }

        function generateTitleFromContent(firstLine) {
            const words = firstLine.trim().split(/\s+/).slice(0, 5);
            return words.join(' ').toUpperCase();
        }

        function processContentForChotha(content) {
            const lines = content.split('\n').map(line => line.trim()).filter(line => line);
            const processed = [];
            
            lines.forEach(line => {
                // Skip very short lines
                if (line.length < 5) return;
                
                // Split long sentences
                const sentences = line.split(/[.!?]+/).filter(s => s.trim());
                
                sentences.forEach(sentence => {
                    let chothaLine = sentence.trim();
                    if (chothaLine.length < 8) return;
                    
                    // Apply Chotha formatting rules
                    chothaLine = applyChothaStyling(chothaLine);
                    
                    if (chothaLine && processed.length < 30) { // Max 30 points per box
                        processed.push(chothaLine);
                    }
                });
            });
            
            return processed;
        }

        function applyChothaStyling(text) {
            return text
                // Remove common filler words
                .replace(/\b(the|and|for|with|from|into|onto|upon|a|an|this|that|these|those)\b/gi, '')
                
                // Replace common words with symbols
                .replace(/\b(is|are|was|were|equals|equal to)\b/gi, '=')
                .replace(/\b(because|since|due to|owing to)\b/gi, '∵')
                .replace(/\b(therefore|thus|so|hence|consequently)\b/gi, '∴')
                .replace(/\b(then|next|after|following|subsequently)\b/gi, '→')
                .replace(/\b(and|plus|also|additionally)\b/gi, '&')
                .replace(/\b(versus|vs|against|compared to)\b/gi, 'vs')
                .replace(/\b(approximately|about|around)\b/gi, '≈')
                .replace(/\b(greater than|more than|above)\b/gi, '>')
                .replace(/\b(less than|below|under)\b/gi, '<')
                
                // Handle lists and separations
                .replace(/,\s+/g, '; ')
                .replace(/:\s+/g, ' → ')
                
                // Clean up extra spaces
                .replace(/\s+/g, ' ')
                .trim();
        }

        function displayChothaBoxes(boxes) {
            const container = document.getElementById('chothaBoxes');
            container.innerHTML = '';
            
            boxes.forEach((box, index) => {
                const boxElement = document.createElement('div');
                boxElement.className = 'chotha-box';
                
                const titleElement = document.createElement('h3');
                titleElement.textContent = box.title;
                
                const contentElement = document.createElement('div');
                contentElement.className = 'content';
                
                const listElement = document.createElement('ul');
                box.content.forEach(point => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `• ${point}`;
                    listElement.appendChild(listItem);
                });
                
                contentElement.appendChild(listElement);
                boxElement.appendChild(titleElement);
                boxElement.appendChild(contentElement);
                container.appendChild(boxElement);
            });
        }

        async function exportToPDF() {
            showStatus('🔄 Generating PDF...', 'success');
            
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                
                const chothaBoxes = document.getElementById('chothaBoxes');
                const canvas = await html2canvas(chothaBoxes, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    width: chothaBoxes.scrollWidth,
                    height: chothaBoxes.scrollHeight
                });
                
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 297; // A4 height in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;
                
                // Add title page
                pdf.setFontSize(20);
                pdf.text('CHOTHA NOTES', 105, 30, { align: 'center' });
                pdf.setFontSize(12);
                pdf.text(`Generated on ${new Date().toLocaleDateString()}`, 105, 45, { align: 'center' });
                
                // Add content
                if (heightLeft < pageHeight - 60) {
                    position = 60;
                } else {
                    pdf.addPage();
                    position = 0;
                }
                
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= (pageHeight - position);
                
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                pdf.save('chotha-notes.pdf');
                showStatus('✅ PDF downloaded successfully!', 'success');
                
            } catch (error) {
                showStatus('❌ Error generating PDF', 'error');
                console.error('PDF export error:', error);
            }
        }

        async function exportToWord() {
            showStatus('🔄 Generating Word document...', 'success');
            
            try {
                const chothaBoxes = document.querySelectorAll('.chotha-box');
                let docContent = 'CHOTHA NOTES\n';
                docContent += '='.repeat(50) + '\n\n';
                docContent += `Generated on: ${new Date().toLocaleString()}\n\n`;
                
                chothaBoxes.forEach((box, index) => {
                    const title = box.querySelector('h3').textContent;
                    const items = Array.from(box.querySelectorAll('li')).map(li => li.textContent);
                    
                    docContent += `${title}\n`;
                    docContent += '-'.repeat(title.length) + '\n';
                    items.forEach(item => {
                        docContent += `${item}\n`;
                    });
                    docContent += '\n';
                });
                
                const blob = new Blob([docContent], {
                    type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
                });
                
                saveAs(blob, 'chotha-notes.docx');
                showStatus('✅ Word document downloaded successfully!', 'success');
                
            } catch (error) {
                showStatus('❌ Error generating Word document', 'error');
                console.error('Word export error:', error);
            }
        }

        function printNotes() {
            showStatus('🖨️ Preparing for print...', 'success');
            setTimeout(() => {
                window.print();
            }, 500);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check if libraries are loaded
            const librariesLoaded = typeof pdfjsLib !== 'undefined' && 
                                   typeof mammoth !== 'undefined' && 
                                   typeof Tesseract !== 'undefined';
            
            if (librariesLoaded) {
                showStatus('📚 Ready to process your study materials! All libraries loaded successfully.', 'success');
            } else {
                showStatus('⚠️ Some libraries are still loading. Please wait a moment...', 'error');
                setTimeout(() => {
                    showStatus('📚 Ready to process your study materials!', 'success');
                }, 3000);
            }
        });

        // Error handling for library loading
        window.addEventListener('error', function(e) {
            if (e.filename && (e.filename.includes('pdf') || e.filename.includes('mammoth') || e.filename.includes('tesseract'))) {
                showStatus('⚠️ Some processing libraries failed to load. Basic functionality available.', 'error');
            }
        });
    </script>
</body>
</html>
